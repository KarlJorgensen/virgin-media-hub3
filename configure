#!/bin/sh

router_password="dssD04vy0z4t"

port_forwarding()
{
    cat <<EOF
tcp 22 192.168.0.2 22
tcp 25 192.168.0.3 25
both 53 192.168.0.2 53
tcp 80 192.168.0.3 80
tcp 143 192.168.0.3 143
tcp 443 192.168.0.3 443
tcp 465 192.168.0.3 465
tcp 587 192.168.0.3 587
tcp 993 192.168.0.3 993
udp 1194 192.168.0.2 1194
EOF
}


ip_to_hex()
{
    echo $1 | awk --field-separator=. '{printf("%02X%02X%02X%02X\n", $1, $2, $3, $4);}'
}

cat <<EOF
<POSTDATAVER>
version 4
</POSTDATAVER>
<CLIENTDB>
 version 1
90:b0:ed:11:58:8e 0 50726563696f7573736950686f6e65 7e6e6f636f6d6d656e747e 00000000
b8:27:eb:27:66:ac 0 7e6e6f686f73747e 7e6e6f636f6d6d656e747e 00000000
00:19:fb:83:71:92 0 756e6b6e6f776e 7e6e6f636f6d6d656e747e 00000000
b8:27:eb:e1:7a:2b 0 5261737062657272794b6f6469 7e6e6f636f6d6d656e747e 00000000
28:f3:66:f9:1f:eb 0 616e64726f69642d64393136313061363461303839383165 7e6e6f636f6d6d656e747e 00000000
94:35:0a:17:4c:f4 0 616e64726f69642d32656561633834326234373838333164 7e6e6f636f6d6d656e747e 00000000
b8:a1:75:2e:38:f9 0 4e502d33323636344d303239393432 7e6e6f636f6d6d656e747e 00000000
c4:42:02:a3:96:53 0 616e64726f69642d63326131353064396662306334333535 7e6e6f636f6d6d656e747e 00000000
00:26:5a:23:c9:f9 0 4449522d363135 7e6e6f636f6d6d656e747e 00000000
</CLIENTDB>
<USR>
1.3.6.1.4.1.4115.1.20.1.1.5.16.1.3.1=${router_password};4;&_=@<20170302 111235>USER
1.3.6.1.4.1.4115.1.20.1.1.5.62.0=1;2;&_=@<20170302 111243>USER
EOF

port_forwarding | (
    id=0
    now=$(date +%s)
    while read proto external_port internal_ip internal_port
    do
	id=$(( $id + 1 ))
	now=$(( $now  + 1 ))
	date="$(date --date=@$now +'%Y%m%d %H%M%S')"
	internal_ip_as_hex=$(ip_to_hex $internal_ip)
	case $proto in
	    tcp) proto_id=1 ;;
	    udp) proto_id=0 ;;
	    both)   proto_id=2 ;;
	esac
	cat <<EOF
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.3.${id}=${internal_port};66;&_=@<$date>USER
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.4.${id}=${internal_port};66;&_=@<$date>USER
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.5.${id}=${proto_id};2;&_=@<$date>USER
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.7.${id}=%24${internal_ip_as_hex};4;&_=@<$date>USER
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.9.${id}=${external_port};66;&_=@<$date>USER
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.10.${id}=${external_port};66;&_=@<$date>USER
1.3.6.1.4.1.4115.1.20.1.1.4.12.1.11.${id}=1;2;&_=@<$date>USER
EOF
    done
)

cat <<EOF
</USR>
<STATIC>
<STATICFILE>
/nvram/8/dhcpd/udhcpd.192.168.0.1.static_leases
74:2f:68:71:e1:69 192.168.0.3
8a:62:20:e2:c8:57 192.168.0.2
</STATICFILE>
</STATIC>
EOF
